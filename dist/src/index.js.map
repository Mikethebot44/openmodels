{"version":3,"sources":["../../src/index.ts","../../src/providers/modal.ts","../../src/providers/base.ts","../../src/streaming.ts","../../src/client.ts"],"sourcesContent":["export { OpenModels, client } from './client';\r\nexport { parseSSEStream, OpenModelsError } from './streaming';\r\nexport { ModalProvider } from './providers/modal';\r\nexport * from './types';\r\n\r\n","import fetch from 'node-fetch';\nimport { BaseProvider } from './base';\nimport { ChatCompletionRequest, EmbeddingRequest, ImageRequest } from '../types';\nimport { OpenModelsError } from '../streaming';\n\nexport class ModalProvider extends BaseProvider {\n  async chat(request: ChatCompletionRequest): Promise<any> {\n    const url = `${this.config.baseUrl}/chat`;\n    \n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.config.apiKey}`,\n    };\n\n    const response = await fetch(url, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(request),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      \n      if (response.status === 401) {\n        throw new OpenModelsError('Invalid API key. Please check your credentials.', 401);\n      }\n      if (response.status === 403) {\n        throw new OpenModelsError('Insufficient credits. Please top up your account.', 403);\n      }\n      \n      throw new OpenModelsError(`Modal API error: ${response.status} ${errorText}`, response.status);\n    }\n\n    return response;\n  }\n\n  async embed(request: EmbeddingRequest): Promise<any> {\n    const url = `${this.config.baseUrl}/embed`;\n    \n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.config.apiKey}`,\n    };\n\n    const response = await fetch(url, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(request),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      \n      if (response.status === 401) {\n        throw new OpenModelsError('Invalid API key. Please check your credentials.', 401);\n      }\n      if (response.status === 403) {\n        throw new OpenModelsError('Insufficient credits. Please top up your account.', 403);\n      }\n      \n      throw new OpenModelsError(`Modal API error: ${response.status} ${errorText}`, response.status);\n    }\n\n    return response;\n  }\n\n  async image(request: ImageRequest): Promise<any> {\n    const url = `${this.config.baseUrl}/image`;\n    \n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.config.apiKey}`,\n    };\n\n    const response = await fetch(url, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(request),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      \n      if (response.status === 401) {\n        throw new OpenModelsError('Invalid API key. Please check your credentials.', 401);\n      }\n      if (response.status === 403) {\n        throw new OpenModelsError('Insufficient credits. Please top up your account.', 403);\n      }\n      \n      throw new OpenModelsError(`Modal API error: ${response.status} ${errorText}`, response.status);\n    }\n\n    return response;\n  }\n}\n","import { ProviderConfig } from '../types';\n\nexport interface Provider {\n  chat(request: any): Promise<any>;\n  embed(request: any): Promise<any>;\n  image(request: any): Promise<any>;\n}\n\nexport abstract class BaseProvider implements Provider {\n  constructor(protected config: ProviderConfig) {}\n  \n  abstract chat(request: any): Promise<any>;\n  abstract embed(request: any): Promise<any>;\n  abstract image(request: any): Promise<any>;\n}\n","import { StreamChunk } from './types';\n\nexport class OpenModelsError extends Error {\n  constructor(\n    message: string,\n    public status?: number,\n    public code?: string\n  ) {\n    super(message);\n    this.name = 'OpenModelsError';\n  }\n}\n\nexport async function* parseSSEStream(\n  response: any\n): AsyncGenerator<string, void, unknown> {\n  if (!response.body) {\n    throw new OpenModelsError('Response body is null');\n  }\n\n  // Handle authentication errors before parsing stream\n  if (response.status === 401) {\n    throw new OpenModelsError('Invalid API key. Please check your credentials.', 401);\n  }\n  if (response.status === 403) {\n    throw new OpenModelsError('Insufficient credits. Please top up your account.', 403);\n  }\n\n  // Handle node-fetch response\n  const text = await response.text();\n  const lines = text.split('\\n');\n\n  for (const line of lines) {\n    const trimmed = line.trim();\n    \n    if (trimmed === '') continue;\n    if (trimmed === '[DONE]') return;\n    \n    if (trimmed.startsWith('data: ')) {\n      const data = trimmed.slice(6);\n      if (data === '[DONE]') return;\n      \n      try {\n        const parsed: StreamChunk = JSON.parse(data);\n        if (parsed.choices?.[0]?.delta?.content) {\n          yield parsed.choices[0].delta.content;\n        }\n      } catch (e) {\n        // Skip malformed JSON\n        continue;\n      }\n    }\n  }\n}\n","import { ModalProvider } from './providers/modal';\nimport { parseSSEStream, OpenModelsError } from './streaming';\nimport { \n  OpenModelsConfig, \n  ChatCompletionRequest, \n  ChatCompletionResponse,\n  EmbeddingRequest,\n  EmbeddingResponse,\n  ImageRequest,\n  ImageResponse\n} from './types';\n\nexport class OpenModels {\n  private textProvider: ModalProvider;\n  private embedProvider: ModalProvider;\n  private imageProvider: ModalProvider;\n\n  constructor(config: OpenModelsConfig = {}) {\n    // Validate that API key is provided\n    if (!config.apiKey) {\n      throw new OpenModelsError('API key is required. Please provide an API key in the client configuration.');\n    }\n\n    // Validate API key format\n    if (!config.apiKey.startsWith('om_') || config.apiKey.length < 10) {\n      throw new OpenModelsError('Invalid API key format. API keys must start with \"om_\" and be at least 10 characters long.');\n    }\n\n    // Determine base URLs for each service\n    const baseUrl = config.baseUrl || 'https://tryscout.dev';\n    \n    // If baseUrl contains modal.run or is a full URL, use as-is\n    // Otherwise, assume it's a base domain and add subfolders\n    const getServiceUrl = (service: string) => {\n      if (baseUrl.includes('modal.run') || baseUrl.includes('/api/')) {\n        // If it's already a full URL or contains subfolder, use as-is\n        return baseUrl;\n      } else if (baseUrl.includes('.')) {\n        // If it's a domain, add subfolder\n        return `${baseUrl}/api/${service}`;\n      } else {\n        // Default to tryscout.dev subfolders\n        return `https://tryscout.dev/api/${service}`;\n      }\n    };\n\n    this.textProvider = new ModalProvider({\n      apiKey: config.apiKey,\n      baseUrl: getServiceUrl('text'),\n    });\n\n    this.embedProvider = new ModalProvider({\n      apiKey: config.apiKey,\n      baseUrl: getServiceUrl('embed'),\n    });\n\n    this.imageProvider = new ModalProvider({\n      apiKey: config.apiKey,\n      baseUrl: getServiceUrl('image'),\n    });\n  }\n\n  async chat(request: ChatCompletionRequest): Promise<ChatCompletionResponse | AsyncGenerator<string, void, unknown>> {\n    try {\n      const response = await this.textProvider.chat(request);\n      \n      if (request.stream) {\n        return parseSSEStream(response);\n      }\n      \n      const data = await response.json();\n      return data as ChatCompletionResponse;\n    } catch (error) {\n      if (error instanceof Error) {\n        throw new OpenModelsError(error.message);\n      }\n      throw new OpenModelsError('Unknown error occurred');\n    }\n  }\n\n  async embed(request: EmbeddingRequest): Promise<EmbeddingResponse> {\n    try {\n      const response = await this.embedProvider.embed(request);\n      const data = await response.json();\n      return data as EmbeddingResponse;\n    } catch (error) {\n      if (error instanceof Error) {\n        throw new OpenModelsError(error.message);\n      }\n      throw new OpenModelsError('Unknown error occurred');\n    }\n  }\n\n  async image(request: ImageRequest): Promise<ImageResponse> {\n    try {\n      const response = await this.imageProvider.image(request);\n      const data = await response.json();\n      return data as ImageResponse;\n    } catch (error) {\n      if (error instanceof Error) {\n        throw new OpenModelsError(error.message);\n      }\n      throw new OpenModelsError('Unknown error occurred');\n    }\n  }\n}\n\nexport function client(config?: OpenModelsConfig): OpenModels {\n  return new OpenModels(config);\n}\n\n"],"mappings":"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","names":["src_exports","__export","ModalProvider","OpenModels","OpenModelsError","client","parseSSEStream","__toCommonJS","import_node_fetch","BaseProvider","config","OpenModelsError","message","status","code","parseSSEStream","response","lines","line","trimmed","data","parsed","ModalProvider","BaseProvider","request","url","headers","response","fetch","errorText","OpenModelsError","OpenModels","config","OpenModelsError","baseUrl","getServiceUrl","service","ModalProvider","request","response","parseSSEStream","error","client"]}